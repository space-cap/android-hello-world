# ê²°ì œ ë° ì¸ì•± êµ¬ë§¤ ì™„ë²½ ê°€ì´ë“œ

## ğŸ“š ëª©ì°¨

1. [ì¸ì•± ê²°ì œë€?](#ì¸ì•±-ê²°ì œë€)
2. [Google Play Billing ì‹œì‘í•˜ê¸°](#google-play-billing-ì‹œì‘í•˜ê¸°)
3. [ì¼íšŒì„± êµ¬ë§¤](#ì¼íšŒì„±-êµ¬ë§¤)
4. [êµ¬ë… ê´€ë¦¬](#êµ¬ë…-ê´€ë¦¬)
5. [ê²°ì œ ê²€ì¦](#ê²°ì œ-ê²€ì¦)
6. [í™˜ë¶ˆ ì²˜ë¦¬](#í™˜ë¶ˆ-ì²˜ë¦¬)
7. [í…ŒìŠ¤íŠ¸](#í…ŒìŠ¤íŠ¸)
8. [ì‹¤ì „ ì˜ˆì œ](#ì‹¤ì „-ì˜ˆì œ)

---

## ì¸ì•± ê²°ì œë€?

> [!NOTE]
> **ì¸ì•± ê²°ì œ = ì•± ë‚´ì—ì„œ ìƒí’ˆì´ë‚˜ ì„œë¹„ìŠ¤ë¥¼ êµ¬ë§¤í•˜ëŠ” ê²ƒ**
> 
> **ì£¼ìš” ìœ í˜•:**
> - ğŸ’° ì¼íšŒì„± êµ¬ë§¤ (ì†Œëª¨ì„±/ë¹„ì†Œëª¨ì„±)
> - ğŸ“… êµ¬ë… (ì›”ê°„/ì—°ê°„)
> - ğŸ ë¬´ë£Œ ì²´í—˜
> - â¬†ï¸ ì—…ê·¸ë ˆì´ë“œ

### ì™œ ì¤‘ìš”í•œê°€?

**ìˆ˜ìµ ëª¨ë¸:**
```
ë¬´ë£Œ ì•± + ê´‘ê³ : ì‚¬ìš©ìë‹¹ ì›” $0.50
ë¬´ë£Œ ì•± + ì¸ì•± êµ¬ë§¤: ì‚¬ìš©ìë‹¹ ì›” $2-5
í”„ë¦¬ë¯¸ì—„ ì•±: ì‚¬ìš©ìë‹¹ $2.99 (1íšŒ)
êµ¬ë… ì•±: ì‚¬ìš©ìë‹¹ ì›” $9.99
```

**í†µê³„:**
- ëª¨ë°”ì¼ ì•± ìˆ˜ìµì˜ **98%**ê°€ ì¸ì•± ê²°ì œ
- êµ¬ë… ëª¨ë¸ì˜ ì—°ê°„ ì„±ì¥ë¥ : **18%**
- í‰ê·  êµ¬ë… ìœ ì§€ìœ¨: **40%** (3ê°œì›” í›„)

### ê²°ì œ ìœ í˜•

**1. ì†Œëª¨ì„± ìƒí’ˆ (Consumable)**
```
ì˜ˆì‹œ: ê²Œì„ ì½”ì¸, ì•„ì´í…œ
íŠ¹ì§•: ì‚¬ìš©í•˜ë©´ ì‚¬ë¼ì§, ì¬êµ¬ë§¤ ê°€ëŠ¥
```

**2. ë¹„ì†Œëª¨ì„± ìƒí’ˆ (Non-consumable)**
```
ì˜ˆì‹œ: í”„ë¦¬ë¯¸ì—„ ì—…ê·¸ë ˆì´ë“œ, ê´‘ê³  ì œê±°
íŠ¹ì§•: í•œ ë²ˆ êµ¬ë§¤í•˜ë©´ ì˜êµ¬ ì†Œìœ 
```

**3. êµ¬ë… (Subscription)**
```
ì˜ˆì‹œ: ì›”ê°„ í”„ë¦¬ë¯¸ì—„, ì—°ê°„ ë©¤ë²„ì‹­
íŠ¹ì§•: ì£¼ê¸°ì ìœ¼ë¡œ ìë™ ê²°ì œ
```

---

## Google Play Billing ì‹œì‘í•˜ê¸°

> [!IMPORTANT]
> **Google Play Billing = Google Playì˜ ê³µì‹ ê²°ì œ ì‹œìŠ¤í…œ**
> 
> **ì™œ ì‚¬ìš©í•´ì•¼ í•˜ëŠ”ê°€?**
> - âœ… Google Play ì •ì±… ì¤€ìˆ˜ (í•„ìˆ˜)
> - âœ… ì•ˆì „í•œ ê²°ì œ ì²˜ë¦¬
> - âœ… ìë™ í™˜ë¶ˆ ì²˜ë¦¬
> - âœ… êµ¬ë… ê´€ë¦¬ ìë™í™”

### 1ë‹¨ê³„: Google Play Console ì„¤ì •

**ë§¤ìš° ìƒì„¸í•œ ë‹¨ê³„:**

1. **Google Play Console ì ‘ì†**
   ```
   https://play.google.com/console ì ‘ì†
   ê°œë°œì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
   (ê°œë°œì ë“±ë¡ë¹„ $25 1íšŒ ê²°ì œ í•„ìš”)
   ```

2. **ì•± ì„ íƒ ë˜ëŠ” ìƒì„±**
   ```
   ê¸°ì¡´ ì•± ì„ íƒ ë˜ëŠ” "ì•± ë§Œë“¤ê¸°" í´ë¦­
   ```

3. **ì¸ì•± ìƒí’ˆ ìƒì„±**
   ```
   ì™¼ìª½ ë©”ë‰´ â†’ "ìˆ˜ìµ ì°½ì¶œ" â†’ "ì¸ì•± ìƒí’ˆ"
   â†“
   "ìƒí’ˆ ë§Œë“¤ê¸°" í´ë¦­
   â†“
   ìƒí’ˆ ì •ë³´ ì…ë ¥:
   - ìƒí’ˆ ID: premium_upgrade (ê³ ìœ  ID, ë³€ê²½ ë¶ˆê°€!)
   - ì´ë¦„: í”„ë¦¬ë¯¸ì—„ ì—…ê·¸ë ˆì´ë“œ
   - ì„¤ëª…: ê´‘ê³  ì œê±° ë° ëª¨ë“  ê¸°ëŠ¥ ì ê¸ˆ í•´ì œ
   - ê°€ê²©: â‚©9,900
   â†“
   "ì €ì¥" í´ë¦­
   ```

**ìƒí’ˆ ID ëª…ëª… ê·œì¹™:**
```kotlin
// âœ… ì¢‹ì€ ì˜ˆ
"premium_upgrade"
"coins_100"
"monthly_subscription"

// âŒ ë‚˜ìœ ì˜ˆ
"product1"  // ì˜ë¯¸ ë¶ˆëª…í™•
"í”„ë¦¬ë¯¸ì—„"  // ì˜ë¬¸ ì‚¬ìš© ê¶Œì¥
"premium upgrade"  // ê³µë°± ì‚¬ìš© ë¶ˆê°€
```

4. **êµ¬ë… ìƒí’ˆ ìƒì„± (ì„ íƒì‚¬í•­)**
   ```
   "ìˆ˜ìµ ì°½ì¶œ" â†’ "êµ¬ë…"
   â†“
   "êµ¬ë… ë§Œë“¤ê¸°" í´ë¦­
   â†“
   êµ¬ë… ì •ë³´ ì…ë ¥:
   - êµ¬ë… ID: monthly_premium
   - ì´ë¦„: ì›”ê°„ í”„ë¦¬ë¯¸ì—„
   - í˜œíƒ: ëª¨ë“  í”„ë¦¬ë¯¸ì—„ ê¸°ëŠ¥
   â†“
   ê¸°ë³¸ í”Œëœ ì¶”ê°€:
   - ê°±ì‹  ìœ í˜•: ìë™ ê°±ì‹ 
   - ì²­êµ¬ ê¸°ê°„: 1ê°œì›”
   - ê°€ê²©: â‚©9,900
   â†“
   ë¬´ë£Œ ì²´í—˜ ì„¤ì • (ì„ íƒ):
   - ì²´í—˜ ê¸°ê°„: 7ì¼
   â†“
   "ì €ì¥" ë° "í™œì„±í™”"
   ```

### 2ë‹¨ê³„: Android í”„ë¡œì íŠ¸ ì„¤ì •

#### ì˜ì¡´ì„± ì¶”ê°€

```kotlin
// build.gradle.kts (Module: app)
dependencies {
    // Google Play Billing Library
    val billingVersion = "6.1.0"
    implementation("com.android.billingclient:billing:$billingVersion")
    
    // Kotlin Coroutines ì§€ì›
    implementation("com.android.billingclient:billing-ktx:$billingVersion")
}
```

**ì™œ billing-ktxë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?**
```kotlin
// billing (ì¼ë°˜)
billingClient.queryPurchasesAsync(...) { billingResult, purchases ->
    // ì½œë°± ì§€ì˜¥
}

// billing-ktx (Kotlin)
val result = billingClient.queryPurchasesAsync(...)
// suspend í•¨ìˆ˜ë¡œ ê¹”ë”!
```

#### AndroidManifest.xml ì„¤ì •

```xml
<!-- AndroidManifest.xml -->
<manifest>
    <!-- ì¸í„°ë„· ê¶Œí•œ (ê²°ì œ í†µì‹ ) -->
    <uses-permission android:name="android.permission.INTERNET" />
    
    <!-- ê²°ì œ ê¶Œí•œ -->
    <uses-permission android:name="com.android.vending.BILLING" />
    
    <application>
        <activity ... />
    </application>
</manifest>
```

### 3ë‹¨ê³„: BillingClient ì´ˆê¸°í™”

```kotlin
class BillingManager(
    private val context: Context
) {
    // BillingClient ì¸ìŠ¤í„´ìŠ¤
    private var billingClient: BillingClient? = null
    
    // ì—°ê²° ìƒíƒœ
    private val _isReady = MutableStateFlow(false)
    val isReady: StateFlow<Boolean> = _isReady.asStateFlow()
    
    // êµ¬ë§¤ ëª©ë¡
    private val _purchases = MutableStateFlow<List<Purchase>>(emptyList())
    val purchases: StateFlow<List<Purchase>> = _purchases.asStateFlow()
    
    init {
        setupBillingClient()
    }
    
    private fun setupBillingClient() {
        // BillingClient ìƒì„±
        billingClient = BillingClient.newBuilder(context)
            .setListener { billingResult, purchases ->
                // êµ¬ë§¤ ì—…ë°ì´íŠ¸ ë¦¬ìŠ¤ë„ˆ
                // ìƒˆ êµ¬ë§¤ê°€ ë°œìƒí•˜ë©´ ìë™ìœ¼ë¡œ í˜¸ì¶œë¨
                if (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {
                    purchases?.let { handlePurchases(it) }
                }
            }
            .enablePendingPurchases()  // ë³´ë¥˜ ì¤‘ì¸ êµ¬ë§¤ í™œì„±í™” (í•„ìˆ˜!)
            .build()
        
        // BillingClient ì—°ê²°
        connectToBillingService()
    }
    
    private fun connectToBillingService() {
        billingClient?.startConnection(object : BillingClientStateListener {
            override fun onBillingSetupFinished(billingResult: BillingResult) {
                if (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {
                    // ì—°ê²° ì„±ê³µ!
                    Log.d("Billing", "BillingClient ì—°ê²° ì„±ê³µ")
                    _isReady.value = true
                    
                    // ê¸°ì¡´ êµ¬ë§¤ ë‚´ì—­ ì¡°íšŒ
                    queryPurchases()
                } else {
                    // ì—°ê²° ì‹¤íŒ¨
                    Log.e("Billing", "ì—°ê²° ì‹¤íŒ¨: ${billingResult.debugMessage}")
                    _isReady.value = false
                }
            }
            
            override fun onBillingServiceDisconnected() {
                // ì—°ê²° ëŠê¹€ (ìë™ìœ¼ë¡œ ì¬ì—°ê²° ì‹œë„)
                Log.w("Billing", "BillingClient ì—°ê²° ëŠê¹€")
                _isReady.value = false
                
                // ì¬ì—°ê²° ì‹œë„
                connectToBillingService()
            }
        })
    }
    
    // ê¸°ì¡´ êµ¬ë§¤ ë‚´ì—­ ì¡°íšŒ
    private fun queryPurchases() {
        // ì¸ì•± ìƒí’ˆ êµ¬ë§¤ ë‚´ì—­
        billingClient?.queryPurchasesAsync(
            QueryPurchasesParams.newBuilder()
                .setProductType(BillingClient.ProductType.INAPP)
                .build()
        ) { billingResult, purchases ->
            if (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {
                handlePurchases(purchases)
            }
        }
        
        // êµ¬ë… êµ¬ë§¤ ë‚´ì—­
        billingClient?.queryPurchasesAsync(
            QueryPurchasesParams.newBuilder()
                .setProductType(BillingClient.ProductType.SUBS)
                .build()
        ) { billingResult, purchases ->
            if (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {
                handlePurchases(purchases)
            }
        }
    }
    
    private fun handlePurchases(purchases: List<Purchase>) {
        // êµ¬ë§¤ ëª©ë¡ ì—…ë°ì´íŠ¸
        _purchases.value = purchases
        
        // ê° êµ¬ë§¤ ì²˜ë¦¬
        purchases.forEach { purchase ->
            when (purchase.purchaseState) {
                Purchase.PurchaseState.PURCHASED -> {
                    // êµ¬ë§¤ ì™„ë£Œ
                    if (!purchase.isAcknowledged) {
                        // êµ¬ë§¤ í™•ì¸ í•„ìš”
                        acknowledgePurchase(purchase)
                    }
                }
                Purchase.PurchaseState.PENDING -> {
                    // êµ¬ë§¤ ë³´ë¥˜ ì¤‘ (ê²°ì œ ëŒ€ê¸°)
                    Log.d("Billing", "êµ¬ë§¤ ë³´ë¥˜ ì¤‘: ${purchase.products}")
                }
                else -> {
                    // ê¸°íƒ€ ìƒíƒœ
                    Log.d("Billing", "êµ¬ë§¤ ìƒíƒœ: ${purchase.purchaseState}")
                }
            }
        }
    }
    
    // êµ¬ë§¤ í™•ì¸ (í•„ìˆ˜!)
    private fun acknowledgePurchase(purchase: Purchase) {
        val acknowledgePurchaseParams = AcknowledgePurchaseParams.newBuilder()
            .setPurchaseToken(purchase.purchaseToken)
            .build()
        
        billingClient?.acknowledgePurchase(acknowledgePurchaseParams) { billingResult ->
            if (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {
                Log.d("Billing", "êµ¬ë§¤ í™•ì¸ ì™„ë£Œ")
            }
        }
    }
    
    // ì •ë¦¬
    fun destroy() {
        billingClient?.endConnection()
    }
}
```

**ì™œ acknowledgePurchaseê°€ í•„ìš”í•œê°€?**
```
êµ¬ë§¤ ì™„ë£Œ â†’ 3ì¼ ì´ë‚´ í™•ì¸ í•„ìš”
           â†“
      í™•ì¸ ì•ˆí•˜ë©´?
           â†“
      ìë™ í™˜ë¶ˆ!
```

---

## ì¼íšŒì„± êµ¬ë§¤

### ìƒí’ˆ ì •ë³´ ì¡°íšŒ

```kotlin
class BillingManager(private val context: Context) {
    // ... (ì´ì „ ì½”ë“œ)
    
    // ìƒí’ˆ ì •ë³´ ì¡°íšŒ
    suspend fun queryProductDetails(
        productIds: List<String>
    ): List<ProductDetails> {
        // ìƒí’ˆ ëª©ë¡ ìƒì„±
        val productList = productIds.map { productId ->
            QueryProductDetailsParams.Product.newBuilder()
                .setProductId(productId)
                .setProductType(BillingClient.ProductType.INAPP)  // ì¸ì•± ìƒí’ˆ
                .build()
        }
        
        // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°
        val params = QueryProductDetailsParams.newBuilder()
            .setProductList(productList)
            .build()
        
        // ìƒí’ˆ ì •ë³´ ì¡°íšŒ
        val result = billingClient?.queryProductDetails(params)
        
        return if (result?.billingResult?.responseCode == BillingClient.BillingResponseCode.OK) {
            result.productDetailsList ?: emptyList()
        } else {
            Log.e("Billing", "ìƒí’ˆ ì¡°íšŒ ì‹¤íŒ¨: ${result?.billingResult?.debugMessage}")
            emptyList()
        }
    }
}

// ì‚¬ìš© ì˜ˆì‹œ
@Composable
fun ProductListScreen(
    billingManager: BillingManager
) {
    var products by remember { mutableStateOf<List<ProductDetails>>(emptyList()) }
    
    LaunchedEffect(Unit) {
        // ìƒí’ˆ ID ëª©ë¡
        val productIds = listOf(
            "premium_upgrade",  // í”„ë¦¬ë¯¸ì—„ ì—…ê·¸ë ˆì´ë“œ
            "coins_100",        // ì½”ì¸ 100ê°œ
            "coins_500"         // ì½”ì¸ 500ê°œ
        )
        
        // ìƒí’ˆ ì •ë³´ ì¡°íšŒ
        products = billingManager.queryProductDetails(productIds)
    }
    
    LazyColumn {
        items(products) { product ->
            ProductCard(
                product = product,
                onPurchase = { /* êµ¬ë§¤ ì²˜ë¦¬ */ }
            )
        }
    }
}

@Composable
fun ProductCard(
    product: ProductDetails,
    onPurchase: () -> Unit
) {
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .padding(8.dp)
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            // ìƒí’ˆ ì´ë¦„
            Text(
                text = product.name,
                style = MaterialTheme.typography.titleMedium
            )
            
            // ìƒí’ˆ ì„¤ëª…
            Text(
                text = product.description,
                style = MaterialTheme.typography.bodyMedium,
                color = Color.Gray
            )
            
            Spacer(modifier = Modifier.height(8.dp))
            
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                // ê°€ê²©
                Text(
                    text = product.oneTimePurchaseOfferDetails?.formattedPrice ?: "",
                    style = MaterialTheme.typography.titleLarge,
                    fontWeight = FontWeight.Bold,
                    color = MaterialTheme.colorScheme.primary
                )
                
                // êµ¬ë§¤ ë²„íŠ¼
                Button(onClick = onPurchase) {
                    Text("êµ¬ë§¤í•˜ê¸°")
                }
            }
        }
    }
}
```

### êµ¬ë§¤ ì‹œì‘

```kotlin
class BillingManager(private val context: Context) {
    // ... (ì´ì „ ì½”ë“œ)
    
    // êµ¬ë§¤ ì‹œì‘
    fun launchPurchaseFlow(
        activity: Activity,
        productDetails: ProductDetails
    ) {
        // êµ¬ë§¤ í”Œë¡œìš° íŒŒë¼ë¯¸í„°
        val productDetailsParamsList = listOf(
            BillingFlowParams.ProductDetailsParams.newBuilder()
                .setProductDetails(productDetails)
                .build()
        )
        
        val billingFlowParams = BillingFlowParams.newBuilder()
            .setProductDetailsParamsList(productDetailsParamsList)
            .build()
        
        // êµ¬ë§¤ í”Œë¡œìš° ì‹œì‘
        val billingResult = billingClient?.launchBillingFlow(activity, billingFlowParams)
        
        when (billingResult?.responseCode) {
            BillingClient.BillingResponseCode.OK -> {
                // êµ¬ë§¤ í”Œë¡œìš° ì‹œì‘ ì„±ê³µ
                Log.d("Billing", "êµ¬ë§¤ í”Œë¡œìš° ì‹œì‘")
            }
            BillingClient.BillingResponseCode.USER_CANCELED -> {
                // ì‚¬ìš©ìê°€ ì·¨ì†Œ
                Log.d("Billing", "ì‚¬ìš©ìê°€ êµ¬ë§¤ ì·¨ì†Œ")
            }
            else -> {
                // ì—ëŸ¬
                Log.e("Billing", "êµ¬ë§¤ í”Œë¡œìš° ì‹¤íŒ¨: ${billingResult?.debugMessage}")
            }
        }
    }
}

// ì‚¬ìš© ì˜ˆì‹œ
@Composable
fun PurchaseButton(
    product: ProductDetails,
    billingManager: BillingManager
) {
    val activity = LocalContext.current as Activity
    
    Button(
        onClick = {
            // êµ¬ë§¤ ì‹œì‘
            billingManager.launchPurchaseFlow(activity, product)
        }
    ) {
        Icon(Icons.Filled.ShoppingCart, null)
        Spacer(modifier = Modifier.width(8.dp))
        Text("êµ¬ë§¤í•˜ê¸°")
    }
}
```

**êµ¬ë§¤ í”Œë¡œìš°:**
```
1. ì‚¬ìš©ìê°€ "êµ¬ë§¤í•˜ê¸°" ë²„íŠ¼ í´ë¦­
   â†“
2. launchBillingFlow() í˜¸ì¶œ
   â†“
3. Google Play ê²°ì œ í™”ë©´ í‘œì‹œ
   â†“
4. ì‚¬ìš©ìê°€ ê²°ì œ ë°©ë²• ì„ íƒ ë° í™•ì¸
   â†“
5. ê²°ì œ ì²˜ë¦¬
   â†“
6. PurchasesUpdatedListener ì½œë°± í˜¸ì¶œ
   â†“
7. acknowledgePurchase() í˜¸ì¶œ (í•„ìˆ˜!)
   â†“
8. ìƒí’ˆ ì œê³µ
```

---

## êµ¬ë… ê´€ë¦¬

### êµ¬ë… ìƒí’ˆ ì¡°íšŒ

```kotlin
// êµ¬ë… ìƒí’ˆ ì¡°íšŒ
suspend fun querySubscriptionDetails(
    subscriptionIds: List<String>
): List<ProductDetails> {
    val productList = subscriptionIds.map { subscriptionId ->
        QueryProductDetailsParams.Product.newBuilder()
            .setProductId(subscriptionId)
            .setProductType(BillingClient.ProductType.SUBS)  // êµ¬ë…
            .build()
    }
    
    val params = QueryProductDetailsParams.newBuilder()
        .setProductList(productList)
        .build()
    
    val result = billingClient?.queryProductDetails(params)
    
    return if (result?.billingResult?.responseCode == BillingClient.BillingResponseCode.OK) {
        result.productDetailsList ?: emptyList()
    } else {
        emptyList()
    }
}
```

### êµ¬ë… êµ¬ë§¤

```kotlin
// êµ¬ë… êµ¬ë§¤
fun launchSubscriptionFlow(
    activity: Activity,
    productDetails: ProductDetails,
    offerToken: String  // êµ¬ë… ì˜¤í¼ í† í°
) {
    val productDetailsParamsList = listOf(
        BillingFlowParams.ProductDetailsParams.newBuilder()
            .setProductDetails(productDetails)
            .setOfferToken(offerToken)  // êµ¬ë…ì€ ì˜¤í¼ í† í° í•„ìš”!
            .build()
    )
    
    val billingFlowParams = BillingFlowParams.newBuilder()
        .setProductDetailsParamsList(productDetailsParamsList)
        .build()
    
    billingClient?.launchBillingFlow(activity, billingFlowParams)
}

// êµ¬ë… ì¹´ë“œ
@Composable
fun SubscriptionCard(
    product: ProductDetails,
    billingManager: BillingManager
) {
    val activity = LocalContext.current as Activity
    
    // êµ¬ë… ì˜¤í¼ (ê°€ê²© í”Œëœ)
    val subscriptionOffer = product.subscriptionOfferDetails?.firstOrNull()
    
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .padding(8.dp)
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            Text(
                text = product.name,
                style = MaterialTheme.typography.titleLarge,
                fontWeight = FontWeight.Bold
            )
            
            Text(
                text = product.description,
                style = MaterialTheme.typography.bodyMedium,
                color = Color.Gray
            )
            
            Spacer(modifier = Modifier.height(16.dp))
            
            // ë¬´ë£Œ ì²´í—˜ ì •ë³´
            subscriptionOffer?.let { offer ->
                val freeTrialPhase = offer.pricingPhases.pricingPhaseList
                    .firstOrNull { it.priceAmountMicros == 0L }
                
                if (freeTrialPhase != null) {
                    Surface(
                        color = MaterialTheme.colorScheme.primaryContainer,
                        shape = RoundedCornerShape(8.dp)
                    ) {
                        Text(
                            text = "ğŸ ${freeTrialPhase.billingPeriod} ë¬´ë£Œ ì²´í—˜",
                            modifier = Modifier.padding(8.dp),
                            fontWeight = FontWeight.Bold
                        )
                    }
                    Spacer(modifier = Modifier.height(8.dp))
                }
                
                // ê°€ê²© ì •ë³´
                val pricingPhase = offer.pricingPhases.pricingPhaseList.last()
                Text(
                    text = "${pricingPhase.formattedPrice} / ${pricingPhase.billingPeriod}",
                    style = MaterialTheme.typography.titleMedium,
                    color = MaterialTheme.colorScheme.primary
                )
            }
            
            Spacer(modifier = Modifier.height(16.dp))
            
            // êµ¬ë… ë²„íŠ¼
            Button(
                onClick = {
                    subscriptionOffer?.let { offer ->
                        billingManager.launchSubscriptionFlow(
                            activity,
                            product,
                            offer.offerToken
                        )
                    }
                },
                modifier = Modifier.fillMaxWidth()
            ) {
                Text("êµ¬ë…í•˜ê¸°")
            }
        }
    }
}
```

### êµ¬ë… ìƒíƒœ í™•ì¸

```kotlin
// êµ¬ë… í™œì„± ì—¬ë¶€ í™•ì¸
fun isSubscriptionActive(subscriptionId: String): Boolean {
    return purchases.value.any { purchase ->
        purchase.products.contains(subscriptionId) &&
        purchase.purchaseState == Purchase.PurchaseState.PURCHASED
    }
}

// ì‚¬ìš© ì˜ˆì‹œ
@Composable
fun PremiumFeatureScreen(
    billingManager: BillingManager
) {
    val isPremium by remember {
        derivedStateOf {
            billingManager.isSubscriptionActive("monthly_premium")
        }
    }
    
    if (isPremium) {
        // í”„ë¦¬ë¯¸ì—„ ê¸°ëŠ¥ í‘œì‹œ
        PremiumContent()
    } else {
        // êµ¬ë… ì•ˆë‚´
        SubscriptionPrompt()
    }
}
```

---

## ê²°ì œ ê²€ì¦

> [!CAUTION]
> **í´ë¼ì´ì–¸íŠ¸ ê²€ì¦ë§Œìœ¼ë¡œëŠ” ë¶€ì¡±í•©ë‹ˆë‹¤!**
> 
> í•´ì»¤ê°€ ì•±ì„ ìˆ˜ì •í•˜ì—¬ êµ¬ë§¤ë¥¼ ìœ„ì¡°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> ì„œë²„ì—ì„œ ë°˜ë“œì‹œ ê²€ì¦í•´ì•¼ í•©ë‹ˆë‹¤.

### ì„œë²„ ê²€ì¦ (ê¶Œì¥)

```kotlin
// 1. í´ë¼ì´ì–¸íŠ¸ì—ì„œ êµ¬ë§¤ í† í°ì„ ì„œë²„ë¡œ ì „ì†¡
suspend fun verifyPurchaseOnServer(
    purchase: Purchase
): Boolean {
    return try {
        val response = apiService.verifyPurchase(
            productId = purchase.products.first(),
            purchaseToken = purchase.purchaseToken,
            orderId = purchase.orderId
        )
        
        response.isValid
    } catch (e: Exception) {
        Log.e("Billing", "ì„œë²„ ê²€ì¦ ì‹¤íŒ¨", e)
        false
    }
}

// 2. ì„œë²„ì—ì„œ Google Play Developer APIë¡œ ê²€ì¦
// (ì„œë²„ ì½”ë“œ - Node.js ì˜ˆì‹œ)
/*
const { google } = require('googleapis');

async function verifyPurchase(packageName, productId, purchaseToken) {
    const auth = new google.auth.GoogleAuth({
        keyFile: 'service-account-key.json',
        scopes: ['https://www.googleapis.com/auth/androidpublisher']
    });
    
    const androidPublisher = google.androidpublisher({
        version: 'v3',
        auth: auth
    });
    
    try {
        const result = await androidPublisher.purchases.products.get({
            packageName: packageName,
            productId: productId,
            token: purchaseToken
        });
        
        // êµ¬ë§¤ ìƒíƒœ í™•ì¸
        return result.data.purchaseState === 0; // 0 = êµ¬ë§¤ë¨
    } catch (error) {
        console.error('ê²€ì¦ ì‹¤íŒ¨:', error);
        return false;
    }
}
*/
```

**ì™œ ì„œë²„ ê²€ì¦ì´ í•„ìš”í•œê°€?**
```
í´ë¼ì´ì–¸íŠ¸ë§Œ ê²€ì¦:
í•´ì»¤ê°€ ì•± ìˆ˜ì • â†’ êµ¬ë§¤ ìœ„ì¡° â†’ ë¬´ë£Œ ì‚¬ìš©

ì„œë²„ ê²€ì¦:
í•´ì»¤ê°€ ì•± ìˆ˜ì • â†’ ì„œë²„ê°€ Googleì— í™•ì¸ â†’ ìœ„ì¡° ê°ì§€ â†’ ì°¨ë‹¨
```

---

## í™˜ë¶ˆ ì²˜ë¦¬

### í™˜ë¶ˆ ê°ì§€

```kotlin
// êµ¬ë§¤ ëª©ë¡ì„ ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸
fun checkForRefunds() {
    queryPurchases()
    
    // ì´ì „ì— ìˆë˜ êµ¬ë§¤ê°€ ì‚¬ë¼ì¡Œë‹¤ë©´ í™˜ë¶ˆë¨
    val previousPurchases = _purchases.value
    val currentPurchases = /* ìƒˆë¡œ ì¡°íšŒí•œ êµ¬ë§¤ */
    
    val refundedPurchases = previousPurchases.filter { previous ->
        currentPurchases.none { it.orderId == previous.orderId }
    }
    
    refundedPurchases.forEach { refunded ->
        // í™˜ë¶ˆ ì²˜ë¦¬
        handleRefund(refunded)
    }
}

fun handleRefund(purchase: Purchase) {
    Log.d("Billing", "í™˜ë¶ˆ ê°ì§€: ${purchase.products}")
    
    // í”„ë¦¬ë¯¸ì—„ ê¸°ëŠ¥ ì œê±°
    removePremiumFeatures()
    
    // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
    showRefundNotification()
}
```

---

## í…ŒìŠ¤íŠ¸

### í…ŒìŠ¤íŠ¸ ê³„ì • ì„¤ì •

**Google Play Consoleì—ì„œ:**
```
1. "ì„¤ì •" â†’ "ë¼ì´ì„ ìŠ¤ í…ŒìŠ¤íŠ¸"
2. "ë¼ì´ì„ ìŠ¤ í…ŒìŠ¤í„°" ì¶”ê°€
3. í…ŒìŠ¤í„° ì´ë©”ì¼ ì…ë ¥ (Gmail)
4. "ì €ì¥"
```

**í…ŒìŠ¤í„° ê¸°ê¸°ì—ì„œ:**
```
1. í…ŒìŠ¤í„° Gmail ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
2. ì•± ì„¤ì¹˜ (ë‚´ë¶€ í…ŒìŠ¤íŠ¸ íŠ¸ë™)
3. êµ¬ë§¤ ì‹œë„
4. "í…ŒìŠ¤íŠ¸ êµ¬ë§¤" í‘œì‹œë¨
5. ì‹¤ì œ ê²°ì œ ì—†ì´ êµ¬ë§¤ ê°€ëŠ¥!
```

### í…ŒìŠ¤íŠ¸ ìƒí’ˆ

```kotlin
// í…ŒìŠ¤íŠ¸ìš© ìƒí’ˆ ID
val TEST_PRODUCT_IDS = listOf(
    "android.test.purchased",  // í•­ìƒ ì„±ê³µ
    "android.test.canceled",   // í•­ìƒ ì·¨ì†Œ
    "android.test.refunded",   // í•­ìƒ í™˜ë¶ˆ
    "android.test.item_unavailable"  // í•­ìƒ ì‹¤íŒ¨
)
```

---

## ì‹¤ì „ ì˜ˆì œ

### ì™„ì „í•œ ê²°ì œ ì‹œìŠ¤í…œ

```kotlin
// ViewModel
@HiltViewModel
class BillingViewModel @Inject constructor(
    private val billingManager: BillingManager
) : ViewModel() {
    
    // ìƒí’ˆ ëª©ë¡
    private val _products = MutableStateFlow<List<ProductDetails>>(emptyList())
    val products: StateFlow<List<ProductDetails>> = _products.asStateFlow()
    
    // êµ¬ë… ëª©ë¡
    private val _subscriptions = MutableStateFlow<List<ProductDetails>>(emptyList())
    val subscriptions: StateFlow<List<ProductDetails>> = _subscriptions.asStateFlow()
    
    // í”„ë¦¬ë¯¸ì—„ ìƒíƒœ
    val isPremium: StateFlow<Boolean> = billingManager.purchases
        .map { purchases ->
            purchases.any { it.products.contains("premium_upgrade") }
        }
        .stateIn(viewModelScope, SharingStarted.WhileSubscribed(), false)
    
    init {
        loadProducts()
    }
    
    private fun loadProducts() {
        viewModelScope.launch {
            // ì¸ì•± ìƒí’ˆ ë¡œë“œ
            _products.value = billingManager.queryProductDetails(
                listOf("premium_upgrade", "coins_100", "coins_500")
            )
            
            // êµ¬ë… ìƒí’ˆ ë¡œë“œ
            _subscriptions.value = billingManager.querySubscriptionDetails(
                listOf("monthly_premium", "yearly_premium")
            )
        }
    }
    
    fun purchase(activity: Activity, product: ProductDetails) {
        billingManager.launchPurchaseFlow(activity, product)
    }
}

// UI
@Composable
fun StoreScreen(
    viewModel: BillingViewModel = hiltViewModel()
) {
    val products by viewModel.products.collectAsState()
    val subscriptions by viewModel.subscriptions.collectAsState()
    val isPremium by viewModel.isPremium.collectAsState()
    
    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(16.dp)
    ) {
        // í”„ë¦¬ë¯¸ì—„ ìƒíƒœ í‘œì‹œ
        if (isPremium) {
            PremiumBadge()
        }
        
        // êµ¬ë… ì„¹ì…˜
        Text(
            "êµ¬ë…",
            style = MaterialTheme.typography.titleLarge,
            fontWeight = FontWeight.Bold
        )
        
        subscriptions.forEach { subscription ->
            SubscriptionCard(
                product = subscription,
                billingManager = viewModel.billingManager
            )
        }
        
        Spacer(modifier = Modifier.height(24.dp))
        
        // ì¸ì•± ìƒí’ˆ ì„¹ì…˜
        Text(
            "ì¸ì•± ìƒí’ˆ",
            style = MaterialTheme.typography.titleLarge,
            fontWeight = FontWeight.Bold
        )
        
        products.forEach { product ->
            ProductCard(
                product = product,
                onPurchase = { /* êµ¬ë§¤ */ }
            )
        }
    }
}
```

---

## ğŸ’¡ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

### 1. êµ¬ë§¤ ë³µì›

```kotlin
// êµ¬ë§¤ ë³µì› ë²„íŠ¼
Button(onClick = {
    billingManager.queryPurchases()
}) {
    Text("êµ¬ë§¤ ë³µì›")
}
```

### 2. ì—ëŸ¬ ì²˜ë¦¬

```kotlin
when (billingResult.responseCode) {
    BillingClient.BillingResponseCode.OK -> {
        // ì„±ê³µ
    }
    BillingClient.BillingResponseCode.USER_CANCELED -> {
        // ì‚¬ìš©ì ì·¨ì†Œ
        Toast.makeText(context, "êµ¬ë§¤ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤", Toast.LENGTH_SHORT).show()
    }
    BillingClient.BillingResponseCode.ITEM_ALREADY_OWNED -> {
        // ì´ë¯¸ ì†Œìœ 
        Toast.makeText(context, "ì´ë¯¸ êµ¬ë§¤í•œ ìƒí’ˆì…ë‹ˆë‹¤", Toast.LENGTH_SHORT).show()
    }
    else -> {
        // ê¸°íƒ€ ì—ëŸ¬
        Toast.makeText(context, "êµ¬ë§¤ ì‹¤íŒ¨: ${billingResult.debugMessage}", Toast.LENGTH_SHORT).show()
    }
}
```

### 3. ë³´ì•ˆ

```kotlin
// âœ… ì„œë²„ì—ì„œ ê²€ì¦
// âœ… ë‚œë…í™” (ProGuard/R8)
// âœ… êµ¬ë§¤ í† í° ì•”í˜¸í™” ì €ì¥
// âŒ í´ë¼ì´ì–¸íŠ¸ë§Œ ê²€ì¦
```

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-12-01  
**ì‘ì„±ì**: Antigravity AI Assistant

Happy Selling! ğŸ’°
